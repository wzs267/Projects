#!/usr/bin/env python3
"""
å¸ˆå¾’åˆä½œçš„å®é™…ä»£ç æ¼”ç¤º
å±•ç¤ºè€å¸ˆå‚…å’Œå­¦ç”Ÿçš„å…·ä½“å·¥ä½œè¿‡ç¨‹
"""

import numpy as np
import torch
import torch.nn as nn
from sklearn.ensemble import RandomForestClassifier

def è€å¸ˆå‚…çš„ç»éªŒå­¦ä¹ è¿‡ç¨‹():
    """æ¼”ç¤ºéšæœºæ£®æ—å¦‚ä½•å­¦ä¹ ç»éªŒ"""
    print("ğŸ‘¨â€ğŸ« è€å¸ˆå‚…å¼€å§‹å­¦ä¹ ç»éªŒ...")
    print("=" * 40)
    
    # æ¨¡æ‹Ÿè®­ç»ƒæ•°æ®
    è®­ç»ƒç‰¹å¾ = np.array([
        [0.8, 0.02, 2500, 1200],  # å¼ºéŸ³ç¬¦
        [0.2, 0.01, 1800, 800],   # å¼±éŸ³  
        [0.9, 0.03, 3200, 1500],  # å¾ˆå¼ºéŸ³ç¬¦
        [0.1, 0.005, 1000, 500],  # é™éŸ³
        [0.6, 0.015, 2200, 1000]  # ä¸­ç­‰
    ])
    è®­ç»ƒæ ‡ç­¾ = np.array([1, 0, 1, 0, 1])
    
    print("ğŸŒ² è€å¸ˆå‚…é›‡ä½£3ä¸ªå°åŠ©æ‰‹ï¼ˆå†³ç­–æ ‘ï¼‰å­¦ä¹ ...")
    
    # åˆ›å»ºéšæœºæ£®æ—ï¼ˆ3æ£µæ ‘ä¾¿äºæ¼”ç¤ºï¼‰
    è€å¸ˆå‚… = RandomForestClassifier(n_estimators=3, max_depth=2, random_state=42)
    è€å¸ˆå‚….fit(è®­ç»ƒç‰¹å¾, è®­ç»ƒæ ‡ç­¾)
    
    print("\nğŸ“š å°åŠ©æ‰‹ä»¬å­¦åˆ°çš„ç»éªŒæ³•åˆ™:")
    
    # æ¨¡æ‹Ÿå†³ç­–æ ‘çš„å­¦ä¹ è¿‡ç¨‹
    for i, å†³ç­–æ ‘ in enumerate(è€å¸ˆå‚….estimators_):
        print(f"\n   ğŸŒ¿ å°åŠ©æ‰‹{i+1}çš„ç»éªŒ:")
        
        # ç®€åŒ–å±•ç¤ºå†³ç­–é€»è¾‘
        if i == 0:
            print("      å¦‚æœ RMSèƒ½é‡ > 0.4:")
            print("         å¦‚æœ é¢‘è°±è´¨å¿ƒ > 2000: é¢„æµ‹'æœ‰éŸ³ç¬¦'")
            print("         å¦åˆ™: é¢„æµ‹'æœ‰éŸ³ç¬¦'") 
            print("      å¦åˆ™: é¢„æµ‹'æ— éŸ³ç¬¦'")
        elif i == 1:
            print("      å¦‚æœ RMSèƒ½é‡ > 0.5:")
            print("         é¢„æµ‹'æœ‰éŸ³ç¬¦'")
            print("      å¦åˆ™:")
            print("         å¦‚æœ é¢‘è°±è´¨å¿ƒ > 1500: é¢„æµ‹'æ— éŸ³ç¬¦'")
            print("         å¦åˆ™: é¢„æµ‹'æ— éŸ³ç¬¦'")
        else:
            print("      å¦‚æœ RMSèƒ½é‡ > 0.3:")
            print("         å¦‚æœ é¢‘è°±è´¨å¿ƒ > 1800: é¢„æµ‹'æœ‰éŸ³ç¬¦'")
            print("         å¦åˆ™: é¢„æµ‹'æœ‰éŸ³ç¬¦'")
            print("      å¦åˆ™: é¢„æµ‹'æ— éŸ³ç¬¦'")
    
    # è€å¸ˆå‚…æ€»ç»“ç»éªŒ
    ç‰¹å¾é‡è¦æ€§ = è€å¸ˆå‚….feature_importances_
    ç‰¹å¾åç§° = ['RMSèƒ½é‡', 'è¿‡é›¶ç‡', 'é¢‘è°±è´¨å¿ƒ', 'é¢‘è°±å¸¦å®½']
    
    print(f"\nğŸ“ è€å¸ˆå‚…çš„ç»éªŒæ€»ç»“:")
    for åç§°, é‡è¦æ€§ in zip(ç‰¹å¾åç§°, ç‰¹å¾é‡è¦æ€§):
        print(f"   {åç§°}: {é‡è¦æ€§:.3f} é‡è¦æ€§")
    
    return è€å¸ˆå‚…

def è€å¸ˆå‚…çš„å¿«é€Ÿåˆ¤æ–­è¿‡ç¨‹(è€å¸ˆå‚…, æ–°ç‰¹å¾):
    """æ¼”ç¤ºéšæœºæ£®æ—çš„é¢„æµ‹è¿‡ç¨‹"""
    print("\nâš¡ è€å¸ˆå‚…çš„å¿«é€Ÿåˆ¤æ–­è¿‡ç¨‹:")
    print("=" * 30)
    
    æ–°ç‰¹å¾ = np.array([[0.7, 0.025, 2800, 1300]])  # ä¸€ä¸ªæ–°çš„éŸ³é¢‘ç‰‡æ®µ
    print(f"ğŸ“¥ æ–°éŸ³é¢‘ç‰¹å¾: RMS={æ–°ç‰¹å¾[0][0]}, é¢‘è°±è´¨å¿ƒ={æ–°ç‰¹å¾[0][2]}")
    
    # è¯¢é—®æ¯ä¸ªå°åŠ©æ‰‹
    print("\nğŸ‘¥ è¯¢é—®å°åŠ©æ‰‹ä»¬çš„æ„è§:")
    ä¸ªåˆ«é¢„æµ‹ = []
    for i, å†³ç­–æ ‘ in enumerate(è€å¸ˆå‚….estimators_):
        é¢„æµ‹ = å†³ç­–æ ‘.predict(æ–°ç‰¹å¾)[0]
        ä¸ªåˆ«é¢„æµ‹.append(é¢„æµ‹)
        ç»“æœ = "æœ‰éŸ³ç¬¦" if é¢„æµ‹ == 1 else "æ— éŸ³ç¬¦"
        print(f"   ğŸŒ¿ å°åŠ©æ‰‹{i+1}: {ç»“æœ}")
    
    # æ°‘ä¸»æŠ•ç¥¨
    æœ‰éŸ³ç¬¦ç¥¨æ•° = sum(ä¸ªåˆ«é¢„æµ‹)
    æ€»ç¥¨æ•° = len(ä¸ªåˆ«é¢„æµ‹)
    è€å¸ˆå‚…æ¦‚ç‡ = æœ‰éŸ³ç¬¦ç¥¨æ•° / æ€»ç¥¨æ•°
    
    print(f"\nğŸ—³ï¸  æŠ•ç¥¨ç»“æœ: {æœ‰éŸ³ç¬¦ç¥¨æ•°}/{æ€»ç¥¨æ•°} ç¥¨è®¤ä¸ºæœ‰éŸ³ç¬¦")
    print(f"ğŸ¯ è€å¸ˆå‚…æœ€ç»ˆå»ºè®®: {è€å¸ˆå‚…æ¦‚ç‡:.3f} æ¦‚ç‡æœ‰éŸ³ç¬¦")
    
    # å®é™…APIè°ƒç”¨éªŒè¯
    å®é™…æ¦‚ç‡ = è€å¸ˆå‚….predict_proba(æ–°ç‰¹å¾)[0][1]
    print(f"âœ… APIéªŒè¯: {å®é™…æ¦‚ç‡:.3f}")
    
    return è€å¸ˆå‚…æ¦‚ç‡, æ–°ç‰¹å¾

def å­¦ç”Ÿçš„æ·±åº¦æ€è€ƒè¿‡ç¨‹():
    """æ¼”ç¤ºç¥ç»ç½‘ç»œçš„æ€è€ƒè¿‡ç¨‹"""
    print("\nğŸ§  å¤©æ‰å­¦ç”Ÿçš„æ·±åº¦æ€è€ƒè¿‡ç¨‹:")
    print("=" * 35)
    
    # ç®€åŒ–çš„ç¥ç»ç½‘ç»œ
    class ç®€åŒ–å­¦ç”Ÿç½‘ç»œ(nn.Module):
        def __init__(self):
            super().__init__()
            self.ç¬¬ä¸€å±‚æ€è€ƒ = nn.Linear(4, 8)
            self.ç¬¬äºŒå±‚æ€è€ƒ = nn.Linear(8, 4) 
            self.æœ€ç»ˆå†³ç­– = nn.Linear(4, 1)
            self.æ¿€æ´»å‡½æ•° = nn.ReLU()
            self.æ¦‚ç‡è½¬æ¢ = nn.Sigmoid()
            
        def forward(self, x, æ˜¾ç¤ºè¿‡ç¨‹=False):
            if æ˜¾ç¤ºè¿‡ç¨‹:
                print(f"   ğŸ“¥ è¾“å…¥ç‰¹å¾: {x.numpy().flatten()}")
            
            # ç¬¬ä¸€å±‚æ€è€ƒ
            ç¬¬ä¸€å±‚è¾“å‡º = self.æ¿€æ´»å‡½æ•°(self.ç¬¬ä¸€å±‚æ€è€ƒ(x))
            if æ˜¾ç¤ºè¿‡ç¨‹:
                print(f"   ğŸ¤” ç¬¬ä¸€å±‚æ€è€ƒç»“æœ: {ç¬¬ä¸€å±‚è¾“å‡º.detach().numpy().flatten()[:4]}...")
                print("      å­¦ç”Ÿå†…å¿ƒ: 'è®©æˆ‘åˆ†æè¿™äº›éŸ³é¢‘ç‰¹å¾çš„æ·±å±‚å«ä¹‰...'")
            
            # ç¬¬äºŒå±‚æ€è€ƒ  
            ç¬¬äºŒå±‚è¾“å‡º = self.æ¿€æ´»å‡½æ•°(self.ç¬¬äºŒå±‚æ€è€ƒ(ç¬¬ä¸€å±‚è¾“å‡º))
            if æ˜¾ç¤ºè¿‡ç¨‹:
                print(f"   ğŸ§ ç¬¬äºŒå±‚æ€è€ƒç»“æœ: {ç¬¬äºŒå±‚è¾“å‡º.detach().numpy().flatten()}")
                print("      å­¦ç”Ÿå†…å¿ƒ: 'ç»¼åˆè¿™äº›æ¨¡å¼ï¼Œæˆ‘å‘ç°äº†ä¸€äº›å…³è”...'")
            
            # æœ€ç»ˆå†³ç­–
            åŸå§‹è¾“å‡º = self.æœ€ç»ˆå†³ç­–(ç¬¬äºŒå±‚è¾“å‡º)
            æœ€ç»ˆæ¦‚ç‡ = self.æ¦‚ç‡è½¬æ¢(åŸå§‹è¾“å‡º)
            if æ˜¾ç¤ºè¿‡ç¨‹:
                print(f"   ğŸ¯ æœ€ç»ˆåˆ¤æ–­: {æœ€ç»ˆæ¦‚ç‡.item():.3f}")
                print("      å­¦ç”Ÿå†…å¿ƒ: 'æ ¹æ®æˆ‘çš„æ·±åº¦åˆ†æï¼Œæ¦‚ç‡åº”è¯¥æ˜¯è¿™ä¸ªå€¼'")
            
            return æœ€ç»ˆæ¦‚ç‡
    
    # åˆ›å»ºå¹¶åˆå§‹åŒ–å­¦ç”Ÿ
    å­¦ç”Ÿ = ç®€åŒ–å­¦ç”Ÿç½‘ç»œ()
    
    # ä½¿ç”¨è€å¸ˆå‚…åˆ†æè¿‡çš„ç‰¹å¾
    éŸ³é¢‘ç‰¹å¾ = torch.FloatTensor([[0.7, 0.025, 2800, 1300]])
    
    print("ğŸ“ å­¦ç”Ÿå¼€å§‹æ·±åº¦åˆ†æ...")
    with torch.no_grad():
        å­¦ç”Ÿé¢„æµ‹ = å­¦ç”Ÿ(éŸ³é¢‘ç‰¹å¾, æ˜¾ç¤ºè¿‡ç¨‹=True)
    
    return å­¦ç”Ÿ, å­¦ç”Ÿé¢„æµ‹.item()

def å¸ˆå¾’åˆä½œå®Œæ•´æ¼”ç¤º():
    """å®Œæ•´çš„å¸ˆå¾’åˆä½œè¿‡ç¨‹"""
    print("\n" + "ğŸ¤ å¸ˆå¾’åˆä½œå®Œæ•´æ¼”ç¤º".center(50, "="))
    
    # ç¬¬1æ­¥ï¼šè€å¸ˆå‚…å­¦ä¹ å’Œåˆ¤æ–­
    è€å¸ˆå‚… = è€å¸ˆå‚…çš„ç»éªŒå­¦ä¹ è¿‡ç¨‹()
    è€å¸ˆå‚…æ¦‚ç‡, ç‰¹å¾ = è€å¸ˆå‚…çš„å¿«é€Ÿåˆ¤æ–­è¿‡ç¨‹(è€å¸ˆå‚…, None)
    
    # ç¬¬2æ­¥ï¼šå­¦ç”Ÿæ·±åº¦æ€è€ƒ
    å­¦ç”Ÿ, å­¦ç”Ÿæ¦‚ç‡ = å­¦ç”Ÿçš„æ·±åº¦æ€è€ƒè¿‡ç¨‹()
    
    # ç¬¬3æ­¥ï¼šå¸ˆå¾’å¯¹è¯
    print(f"\nğŸ’¬ å¸ˆå¾’å¯¹è¯è¿‡ç¨‹:")
    print(f"   ğŸŒ² è€å¸ˆå‚…: 'æ ¹æ®æˆ‘30å¹´ç»éªŒï¼Œè¿™ä¸ªæ—¶é—´ç‚¹æœ‰{è€å¸ˆå‚…æ¦‚ç‡:.1%}æ¦‚ç‡æœ‰éŸ³ç¬¦'")
    print(f"   ğŸ§  å­¦    ç”Ÿ: 'å¸ˆå‚…è¯´å¾—æœ‰é“ç†ï¼Œä½†æˆ‘çš„æ·±åº¦åˆ†ææ˜¾ç¤ºæ˜¯{å­¦ç”Ÿæ¦‚ç‡:.1%}'")
    
    # ç¬¬4æ­¥ï¼šæƒé‡èåˆï¼ˆç®€åŒ–ç‰ˆï¼‰
    èåˆæƒé‡_è€å¸ˆå‚… = 0.4
    èåˆæƒé‡_å­¦ç”Ÿ = 0.6
    èåˆæ¦‚ç‡ = è€å¸ˆå‚…æ¦‚ç‡ * èåˆæƒé‡_è€å¸ˆå‚… + å­¦ç”Ÿæ¦‚ç‡ * èåˆæƒé‡_å­¦ç”Ÿ
    
    print(f"   ğŸ¤ èåˆå†³ç­–: {èåˆæƒé‡_è€å¸ˆå‚…}Ã—{è€å¸ˆå‚…æ¦‚ç‡:.3f} + {èåˆæƒé‡_å­¦ç”Ÿ}Ã—{å­¦ç”Ÿæ¦‚ç‡:.3f} = {èåˆæ¦‚ç‡:.3f}")
    
    # ç¬¬5æ­¥ï¼šæœ€ç»ˆå†³ç­–
    æœ€ç»ˆå†³ç­– = èåˆæ¦‚ç‡ > 0.5
    å†³ç­–æ–‡å­— = "æ”¾ç½®éŸ³ç¬¦" if æœ€ç»ˆå†³ç­– else "è·³è¿‡æ­¤æ—¶æœº"
    
    print(f"\nğŸ¯ æœ€ç»ˆå†³ç­–: {èåˆæ¦‚ç‡:.3f} > 0.5 â†’ {å†³ç­–æ–‡å­—}")
    
    return {
        'è€å¸ˆå‚…æ¦‚ç‡': è€å¸ˆå‚…æ¦‚ç‡,
        'å­¦ç”Ÿæ¦‚ç‡': å­¦ç”Ÿæ¦‚ç‡, 
        'èåˆæ¦‚ç‡': èåˆæ¦‚ç‡,
        'æœ€ç»ˆå†³ç­–': æœ€ç»ˆå†³ç­–
    }

def å‚æ•°æ›´æ–°æ¼”ç¤º():
    """æ¼”ç¤ºå­¦ç”Ÿçš„å­¦ä¹ è¿‡ç¨‹"""
    print("\nğŸ“š å­¦ç”Ÿçš„å­¦ä¹ è¿‡ç¨‹æ¼”ç¤º:")
    print("=" * 30)
    
    # ç®€å•çš„å­¦ä¹ ç¤ºä¾‹
    å­¦ç”Ÿ = nn.Sequential(
        nn.Linear(2, 4),
        nn.ReLU(),
        nn.Linear(4, 1),
        nn.Sigmoid()
    )
    
    # è®­ç»ƒæ•°æ®
    è®­ç»ƒX = torch.FloatTensor([[0.8, 2500], [0.2, 1800], [0.9, 3200]])
    è®­ç»ƒY = torch.FloatTensor([[1.0], [0.0], [1.0]])
    
    ä¼˜åŒ–å™¨ = torch.optim.Adam(å­¦ç”Ÿ.parameters(), lr=0.1)
    æŸå¤±å‡½æ•° = nn.BCELoss()
    
    print("ğŸ¯ å­¦ç”Ÿåšé¢˜å’Œæ”¹è¿›è¿‡ç¨‹:")
    for è½®æ¬¡ in range(3):
        # å­¦ç”Ÿåšé¢˜
        é¢„æµ‹ç­”æ¡ˆ = å­¦ç”Ÿ(è®­ç»ƒX)
        æŸå¤± = æŸå¤±å‡½æ•°(é¢„æµ‹ç­”æ¡ˆ, è®­ç»ƒY)
        
        print(f"\n   ç¬¬{è½®æ¬¡+1}è½®:")
        print(f"   å­¦ç”Ÿç­”æ¡ˆ: {é¢„æµ‹ç­”æ¡ˆ.detach().numpy().flatten()}")
        print(f"   æ ‡å‡†ç­”æ¡ˆ: {è®­ç»ƒY.numpy().flatten()}")
        print(f"   é”™è¯¯ç¨‹åº¦: {æŸå¤±.item():.3f}")
        
        # å­¦ç”Ÿåæ€å’Œæ”¹è¿›
        ä¼˜åŒ–å™¨.zero_grad()
        æŸå¤±.backward()
        ä¼˜åŒ–å™¨.step()
        
        if è½®æ¬¡ < 2:
            print("   ğŸ¤” å­¦ç”Ÿå†…å¿ƒ: 'æˆ‘é”™åœ¨å“ªé‡Œï¼Ÿè®©æˆ‘è°ƒæ•´æ€ç»´æ–¹å¼...'")

if __name__ == "__main__":
    # è¿è¡Œå®Œæ•´æ¼”ç¤º
    ç»“æœ = å¸ˆå¾’åˆä½œå®Œæ•´æ¼”ç¤º()
    å‚æ•°æ›´æ–°æ¼”ç¤º()
    
    print(f"\nğŸ‰ æ¼”ç¤ºæ€»ç»“:")
    print(f"   è¿™å°±æ˜¯æˆ‘ä»¬æ··åˆæ¨¡å‹çš„å·¥ä½œåŸç†ï¼")
    print(f"   è€å¸ˆå‚…æä¾›ç¨³å®šç»éªŒï¼Œå­¦ç”Ÿè´¡çŒ®æ·±åº¦åˆ†æï¼Œ")
    print(f"   ä¸¤è€…ç»“åˆè¾¾åˆ°æ›´é«˜çš„å‡†ç¡®ç‡ã€‚")
