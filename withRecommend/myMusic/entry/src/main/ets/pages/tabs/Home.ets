import {SwiperModel,SongListModel,SingerModel,RecommendSongModel,SongModel} from '../model/AppModel'
import {getSwiperList,getRecommendSongList,getRecommendSinger,getRecommendSongs} from '../common/Api'
import {ConfigUtil as Config} from '../common/ConfigUtil'
import router from '@ohos.router';
import { PlayStateModel } from '../model/PlayStateModel'
import emitter from '@ohos.events.emitter'
import { EmitEventType } from '../model/paramModel'

@Component
export struct Home{
  @State swiperList:SwiperModel[] = []
  @State songList:SongListModel[] = []
  @State recommendSongs:RecommendSongModel[] = [] // æ–°å¢ï¼šAIæ¨èå•æ›²
  @State singerList:SingerModel[] = []
  @StorageLink("userInfo") userInfo: Record<string, ESObject> = {}  // è·å–ç”¨æˆ·ä¿¡æ¯ç”¨äºä¸ªæ€§åŒ–æ¨è
  // è·å–è½®æ’­å›¾æ¥å£
  async getSwiperData(){  /// async...await
    const res = await getSwiperList()
    this.swiperList = JSON.parse(JSON.stringify(res.data))
    console.log('swiperList'+ JSON.stringify(this.swiperList))
  }
  // è·å–æ¨èæ­Œå•æ¥å£ -> æ”¹ä¸ºè·å–AIæ¨èå•æ›²
  async recommendSongListData(){
    try {
      // ä¼˜å…ˆä½¿ç”¨AIæ¨è
      const userId = (this.userInfo?.user?.id as number) || 3; // é»˜è®¤ç”¨æˆ·IDä¸º3
      const res = await getRecommendSongs(userId, 6);
      // æ£€æŸ¥å“åº”æ˜¯å¦åŒ…å«codeå±æ€§ï¼ˆåç«¯è¿”å›æ ¼å¼ï¼‰æˆ–successå±æ€§ï¼ˆResponseModelæ ¼å¼ï¼‰
      const resRecord = res as Record<string, ESObject>;
      const isSuccess = resRecord.code === 200 || res.success;
      const responseData: ESObject = resRecord.data || res.data;
      
      if (isSuccess && responseData) {
        this.recommendSongs = responseData as RecommendSongModel[];
        console.log('AIæ¨èå•æ›²:', JSON.stringify(this.recommendSongs));
      } else {
        // é™çº§åˆ°åŸæœ‰æ­Œå•æ¨è
        const fallbackRes = await getRecommendSongList();
        this.songList = JSON.parse(JSON.stringify(fallbackRes.data));
      }
    } catch (error) {
      console.error('æ¨èè·å–å¤±è´¥:', error);
      // é™çº§åˆ°åŸæœ‰æ­Œå•æ¨è
      const fallbackRes = await getRecommendSongList();
      this.songList = JSON.parse(JSON.stringify(fallbackRes.data));
    }
  }
  // è·å–æ¨èæ­Œæ‰‹æ¥å£
  async recommendSingerData(){
    const res = await getRecommendSinger()
    this.singerList = JSON.parse(JSON.stringify(res.data))

  }
  // ç”Ÿå‘½å‘¨æœŸ
  aboutToAppear(): void {
    this.getSwiperData()
    this.recommendSongListData()
    this.recommendSingerData()
  }
  @Builder
  getSwiperListWidget(){
    Swiper() {
      ForEach(this.swiperList, (item: SwiperModel) => {
        Image(`${Config.SERVER_URL}${item.imgurl}`)
          .width('100%')
          .height('400lpx')
          .objectFit(ImageFit.Cover)
      }, (item: SwiperModel) => item.id.toString())
    }
    .loop(true)  //æ— é™å¾ªç¯
    .autoPlay(true) // è‡ªåŠ¨æ’­æ”¾
    .interval(2000) // è½®æ’­é—´éš”æ—¶é—´
    //.displayArrow(true)
    .indicator(  // æŒ‡ç¤ºå™¨
      Indicator.dot()
        .left(0)
        .itemWidth('30lpx')
        .itemHeight('30lpx')
        .selectedItemWidth('60lpx')
        .selectedItemHeight('30lpx')
        .color('#999999')
        .selectedColor('#ff6600')
    )
    .height('460lpx')
  }
  @Builder
  getSongListWidget(){
    //   AIæ¨èå•æ›²
    Column() {
      this.TitleBar('AIæ¨èå•æ›²')
      // æ¨èå•æ›²åˆ—è¡¨
      if (this.recommendSongs.length > 0) {
        // ä½¿ç”¨AIæ¨èç»“æœ
        Column({ space: '20lpx' }) {
          ForEach(this.recommendSongs, (item: RecommendSongModel) => {
            Row() {
              // æ­Œæ›²å°é¢
              Image(Config.SERVER_URL + item.pic)
                .width('120lpx')
                .height('120lpx')
                .borderRadius('12lpx')
                .objectFit(ImageFit.Cover)
              
              // æ­Œæ›²ä¿¡æ¯
              Column() {
                Row() {
                  Text(item.name)
                    .fontSize('32lpx')
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#FF000000')
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                  
                  // æ¨èæ ‡ç­¾
                  Text('AIæ¨è')
                    .fontSize('20lpx')
                    .fontColor('#FF007DFF')
                    .backgroundColor('#1A007DFF')
                    .padding({ left: '8lpx', right: '8lpx', top: '4lpx', bottom: '4lpx' })
                    .borderRadius('8lpx')
                }
                .width('100%')
                .justifyContent(FlexAlign.SpaceBetween)
                .alignItems(VerticalAlign.Center)
                
                if (item.singer?.name) {
                  Text(item.singer.name)
                    .fontSize('24lpx')
                    .fontColor('#FF666666')
                    .margin({ top: '8lpx' })
                }
                
                if (item.reason) {
                  Text(item.reason)
                    .fontSize('20lpx')
                    .fontColor('#FF999999')
                    .margin({ top: '8lpx' })
                }
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Start)
              .margin({ left: '24lpx' })
              
              // æ’­æ”¾æŒ‰é’®
              Text("â–¶")
                .width('48lpx')
                .height('48lpx')
                .fontSize('24lpx')
                .fontColor('#FF007DFF')
                .textAlign(TextAlign.Center)
                .borderRadius('24lpx')
                .backgroundColor('#F0F0F0')
            }
            .width('100%')
            .padding('16lpx')
            .backgroundColor('#FFFFFFFF')
            .borderRadius('16lpx')
            .shadow({
              radius: 8,
              color: '#1F000000',
              offsetX: 0,
              offsetY: 2
            })
            .onClick(() => {
              // æ’­æ”¾æ¨èæ­Œæ›²
              this.playRecommendSong(item);
            })
          })
        }
        .padding({
          left: '16lpx',
          right: '16lpx'
        })
      } else {
        // é™çº§æ˜¾ç¤ºåŸæœ‰æ­Œå•
        Row() {
          Flex({
            wrap:FlexWrap.Wrap
          }){
            ForEach(this.songList, (item: SongListModel) => {
              Column() {
                Row() {
                  Image(Config.SERVER_URL +item.pic)
                    .width('100%')
                    .aspectRatio(1)
                    .borderRadius('16lpx')
                  Text(item.style)
                    .fontColor(Color.White)
                    .fontSize('24lpx')
                    .fontWeight(FontWeight.Bold)
                    .position({
                      x: '12lpx',
                      y: '12lpx'
                    })
                }
                Text(item.title)
                  .textAlign(TextAlign.Start)
                  .fontSize('24lpx')
                  .fontColor(Color.Black)
                  .maxLines(2)
                  .textOverflow({
                    overflow: TextOverflow.Ellipsis
                  })
                  .margin({
                    top: '16lpx'
                  })
              }
              .justifyContent(FlexAlign.SpaceBetween)
              .width('33%')
              .onClick(()=>{
                router.pushUrl({
                  url: 'pages/SongListDetail',
                  params: {
                    cid: item.id
                  }
                })
              })
            })
          }
        }
        .padding({
          left: '16lpx',
          right: '16lpx'
        })
      }
    }
  }
  
  // æ’­æ”¾æ¨èæ­Œæ›²çš„æ–¹æ³•
  playRecommendSong(song: RecommendSongModel) {
    const playList = [song]; // å°†æ¨èæ­Œæ›²ä½œä¸ºæ’­æ”¾åˆ—è¡¨
    const playState = new PlayStateModel({
      pic: song.pic,
      name: song.name,
      url: song.url,
      playIndex: 0,
      time: 0,
      duration: 0,
      isPlay: true,
      playMode: "auto",
      playList: playList
    });
    
    // å‘é€æ’­æ”¾äº‹ä»¶
    emitter.emit({ eventId: EmitEventType.UPDATE_STATE }, {
      data: { playStateStr: JSON.stringify(playState) }
    });
    
    console.log('å¼€å§‹æ’­æ”¾AIæ¨èæ­Œæ›²:', song.name);
  }
  @Builder
  getSingerWidget(){
    // æ¨èæ­Œæ‰‹
    Column() {
      this.TitleBar('æ¨èæ­Œæ‰‹')
      // æ­Œå•é¡¹
      Row() {
        Scroll() {
          Row({ space: '16lpx' }) {
            ForEach(this.singerList, (item: SingerModel) => {
              Column() {
                Row() {
                  Image(Config.SERVER_URL+item.pic)
                    .width('100%')
                    .borderRadius('16lpx')
                  Text(item.name)
                    .fontColor(Color.White)
                    .fontSize('24lpx')
                    .fontWeight(FontWeight.Bold)
                    .position({
                      x: '12lpx',
                      y: '12lpx'
                    })
                }
                Text(item.name)
                  .textAlign(TextAlign.Start)
                  .fontSize('24lpx')
                  .fontColor('#FFE9DFDF')
                  .maxLines(2)
                  .textOverflow({
                    overflow: TextOverflow.Ellipsis
                  })
                  .margin({
                    top: '16lpx'
                  })
              }
              .justifyContent(FlexAlign.SpaceBetween)
              .width('30%')
              .onClick(()=>{
                router.pushUrl({
                  url: 'pages/SingerDetail',
                  params: {
                    cid: item.id
                  }
                })
              })
            })
          }
        }
        .width('100%')
        .scrollable(ScrollDirection.Horizontal).scrollBar(BarState.Off)
      }
      .padding({
        left: '16lpx',
        right: '16lpx'
      })
    }
  }
  // æ ‡é¢˜
  @Builder
  TitleBar(title: string) {
    // æ ‡é¢˜
    Row() {
      Text(title)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.Black)
        .fontSize('36lpx')
      Text('æ›´å¤š')
        .fontColor(Color.Gray)
        .onClick(() => {
          if (title=='æ¨èæ­Œå•') {
            router.pushUrl({url:'pages/AllSongList'})
          }else{
            router.pushUrl({url:'pages/AllSingerList'})
          }
        })
    }
    .width('100%')
    .height('100lpx')
    .padding('16lpx')
    .justifyContent(FlexAlign.SpaceBetween)
  }
  // æœç´¢æ¡†
  @Builder
  SearchInput() {
    Row() {
      Row({ space: '8lpx' }) {
        Image($r('app.media.ic_search'))
          .width('40lpx')
          .aspectRatio(1)
          .fillColor('#6a828e')
        Text('ç”Ÿå¦‚å¤èŠ±ğŸ”¥')
          .fontColor('#6a828e')
          .layoutWeight(1)
        Image($r('app.media.ic_code'))
          .width('40lpx')
          .aspectRatio(1)
          .fillColor('#6a828e')
      }
      .width('100%')
      .padding('24lpx')
      .borderRadius('60')
      .backgroundColor('#cccccc')
      .onClick(()=> {
        router.pushUrl({
          url: "pages/Search1"
        })
      })
    }
    .width('100%')
    .padding('24lpx')
  }
  build() {
    Column() {
      Scroll(){
        Column() {
          this.SearchInput()
          this.getSwiperListWidget()
          this.getSongListWidget()
          this.getSingerWidget()
        }
      }
    }
    .width('100%')
    .height('100%')
  }
}